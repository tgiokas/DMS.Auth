<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMS.Auth - MFA Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }

        input, button {
            margin: 10px;
            padding: 10px;
            width: 250px;
        }

        #qr-code, #otp-form {
            display: none;
        }
    </style>
</head>
<body>

    <h1>DMS.Auth - MFA Login</h1>

    <!-- Login Form -->
    <div id="login-form">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Enter Username" required><br>
        <input type="password" id="password" placeholder="Enter Password" required><br>
        <button onclick="login()">Login</button>
    </div>

    <!-- QR Code for TOTP Setup -->
    <div id="qr-code">
        <h2>Scan this QR Code in Google Authenticator</h2>
        <img id="qr-img" src="" alt="QR Code">
    </div>

    <!-- OTP Submission -->
    <div id="otp-form">
        <h2>Enter OTP Code</h2>
        <input type="text" id="otp" placeholder="Enter OTP Code"><br>
        <button onclick="submitOTP()">Verify OTP</button>
    </div>

    <script>
        const dmsAuthBaseUrl = "http://localhost:5032"; // Replace with your DMS.Auth base URL
        let loginData = {};

        async function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            const response = await fetch(`${dmsAuthBaseUrl}/webapi/api/auth/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: new URLSearchParams({
                    //client_id: "dms-client",
                    //grant_type: "password",
                    username,
                    password
                })
            });

            const data = await response.json();

            if (data.access_token) {
                alert("Login successful!");
                console.log("Access Token:", data.access_token);
            } else if (data.error_description === "Missing OTP") {
                loginData = { username, password };
                document.getElementById("login-form").style.display = "none";
                document.getElementById("otp-form").style.display = "block";
            } else if (data.error_description === "Action required") {
                alert("TOTP setup required! Generating QR Code...");
                await generateTOTPSecret(username);
            } else {
                alert("Login failed: " + (data.error_description || "Unknown error"));
            }
        }

        async function generateTOTPSecret(username) {
            // Get User ID from DMS.Auth/UserController
            const userResponse = await fetch(`${dmsAuthBaseUrl}/api/users/by-username/${username}`);
            const user = await userResponse.json();
            const userId = user.id;

            // Request TOTP Secret from DMS.Auth/UserController
            const totpResponse = await fetch(`${dmsAuthBaseUrl}/api/users/${userId}/totp`, {
                method: "POST"
            });

            const totpData = await totpResponse.json();
            if (totpData.secret) {
                const totpUrl = `otpauth://totp/DMSRealm:${username}?secret=${totpData.secret}&issuer=DMSRealm`;
                document.getElementById("qr-img").src = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(totpUrl)}`;
                document.getElementById("qr-code").style.display = "block";
                document.getElementById("otp-form").style.display = "block";
            } else {
                alert("Error fetching TOTP secret. Try again.");
            }
        }

        async function submitOTP() {
            const otp = document.getElementById("otp").value;

            const response = await fetch(`${dmsAuthBaseUrl}/api/auth/token`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                    client_id: "dms-client",
                    grant_type: "password",
                    username: loginData.username,
                    password: loginData.password,
                    otp
                })
            });

            const data = await response.json();

            if (data.access_token) {
                alert("MFA setup complete! Login successful.");
                console.log("Access Token:", data.access_token);
            } else {
                alert("Invalid OTP. Try again.");
            }
        }
    </script>

</body>
</html>
